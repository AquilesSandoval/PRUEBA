<!DOCTYPE html>
<html lang="ES-es">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Aiym Panel :: AIYM YUC</title>
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <link rel="icon" type="image/png" href="../assets/favicon-32x32.png">
    
    <link href="../assets/fonts.min.css" rel="stylesheet">
    <link href="../assets/bootstrap.min.css" rel="stylesheet">
    <link href="../assets/atlantis2.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/demo.css">
    <link rel="stylesheet" href="../assets/alertif.min.css">
    <link rel="stylesheet" href="../assets/training-app-styles.css">
</head>

<body data-background-color="bg3">
    <div class="wrapper page-container">
        <div class="main-header" data-background-color="white">
            <div class="nav-top">
                <div class="container d-flex flex-row">
                    <button class="topbar-toggler more"><i class="icon-options-vertical"></i></button>
                    <a class="logo d-flex align-items-center" href="../index.html">
                        <img src="../assets/logo_all.png" alt="logo" class="navbar-brand">
                    </a>
                    
                    <nav class="navbar navbar-header navbar-expand-lg p-0">
                        <div class="container-fluid p-0">
                            <ul class="navbar-nav topbar-nav ml-md-auto align-items-center">
                                <li class="nav-item dropdown hidden-caret">
                                    <a class="nav-link" data-toggle="dropdown" href="#" aria-expanded="false" title="Entrenamientos">
                                        <img src="../assets/menu_entrenamientos.png" style="width: 28px;">
                                    </a>
                                    <div class="dropdown-menu quick-actions quick-actions-info animated fadeIn">
                                        <div class="quick-actions-scroll scrollbar-outer">
                                            <div class="quick-actions-items">
                                                <div class="row m-0">
                                                    <a class="col-6 col-md-4 p-0" href="../POSIBLES NO NECESARIOS/EJERCICIO/EJERCICIO INICIO.html"><div class="quick-actions-item">
                                                        <img src="../assets/m_ejercicio.png" style="width: 40px;">
                                                        <span class="text">Ejercicio</span>
                                                    </div></a>
                                                    <a class="col-6 col-md-4 p-0" href="../POSIBLES NO NECESARIOS/Circuitos/INICIO CIRCUITO.html"><div class="quick-actions-item">
                                                        <img src="../assets/m_circuito.png" style="width: 40px;">
                                                        <span class="text">Circuito</span>
                                                    </div></a>
                                                    <a class="col-6 col-md-4 p-0" href="../POSIBLES NO NECESARIOS/DRILLS/INICIO DRILLS.html"><div class="quick-actions-item">
                                                        <img src="../assets/drills.svg" style="width: 32px;margin-top:4px;margin-bottom:4px">
                                                        <span class="text">Drills</span>
                                                    </div></a>
                                                    <a class="col-6 col-md-4 p-0" href="../MICRO/INICIO MICRO.html"><div class="quick-actions-item">
                                                        <img src="../assets/m_micro.png" style="width: 40px;">
                                                        <span class="text">Microciclo</span>
                                                    </div></a>
                                                    <a class="col-6 col-md-4 p-0" href="../MESO/INICIO MESO.html"><div class="quick-actions-item">
                                                        <img src="../assets/m_meso.png" style="width: 40px;">
                                                        <span class="text">Mesociclo</span>
                                                    </div></a>
                                                    <a class="col-6 col-md-4 p-0" href="../MACRO/listado-macrociclos.html"><div class="quick-actions-item">
                                                        <img src="../assets/m_macro.png" style="width: 40px;">
                                                        <span class="text">Macrociclo</span>
                                                    </div></a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </li>

                                <li class="nav-item dropdown hidden-caret">
                                    <a class="dropdown-toggle profile-pic" data-toggle="dropdown" href="#" aria-expanded="false">
                                        <div style="float: left; padding: 10px 7px; color: #535353;">| YUC</div>
                                        <div class="avatar-sm" style="float: left;">
                                            <img src="../assets/user_242.png" alt="..." class="avatar-img rounded-circle imgshadow">
                                        </div>
                                    </a>
                                    <ul class="dropdown-menu dropdown-user animated fadeIn">
                                        <div class="dropdown-user-scroll scrollbar-outer">
                                            <li>
                                                <div class="user-box">
                                                    <div class="avatar-lg">
                                                        <img src="../assets/user_242.png" alt="image profile" class="avatar-img rounded">
                                                    </div>
                                                    <div class="u-text">
                                                        <h4></h4>
                                                        <p class="text-muted">AIYM YUC</p>
                                                    </div>
                                                </div>
                                            </li>
                                            <li>
                                                <div class="dropdown-divider"></div>
                                                <a class="dropdown-item" href="#" onclick="logout(); return false;" style="color:#777; font-weight:400;">Salir</a>
                                            </li>
                                        </div>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </nav>
                </div>
            </div>
        </div>

        <div class="main-panel">
            <div class="container" style="min-height: 550px;">
                <div class="page-inner">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="page-header">
                                <h4 class="page-title">Listado de Mesociclos</h4>
                                <ul class="breadcrumbs" style="font-weight: 400;">
                                    <li class="nav-home">
                                        <a href="../index.html"><i class="flaticon-home"></i></a>
                                    </li>
                                    <li class="separator"><i class="flaticon-right-arrow"></i></li>
                                    <li class="nav-item">Consulta</li>
                                </ul>
                            </div>
                            
                            <div class="card">
                                <div class="card-body">
                                    <div id="loadingMesos" class="text-center py-5">
                                        <div class="spinner-border" style="width: 3rem; height: 3rem; color: #003B5C;" role="status">
                                            <span class="sr-only">Cargando...</span>
                                        </div>
                                        <p class="mt-3 text-muted">Cargando mesociclos...</p>
                                    </div>
                                    <div id="w0" class="grid-view" style="display:none;">
                                        <a href="javascript:;" id="clearFilter" style="color:#003e59;"><i class="fa fa-minus-square"></i> Limpiar filtro</a> | <span id="resultCount">Viendo 0 de 0 resultados.</span>
                                        <table class="table table-striped table-bordered tblresponsive">
                                            <colgroup>
                                                <col>
                                                <col>
                                                <col style="width:110px;">
                                            </colgroup>
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th>Código</th>
                                                    <th class="action-column">&nbsp;</th>
                                                </tr>
                                                <tr id="w0-filters" class="filters">
                                                    <td data-th="Buscar por:">&nbsp;</td>
                                                    <td data-th="Código">
                                                        <input type="text" class="form-control" id="filterInput" placeholder="Buscar...">
                                                    </td>
                                                    <td>&nbsp;</td>
                                                </tr>
                                            </thead>
                                            <tbody id="mesosTableBody">
                                                <!-- Rows will be loaded here -->
                                            </tbody>
                                        </table>
                                        
                                        <div id="pagination" class="text-center mt-3" style="display: block !important;">
                                            <nav>
                                                <ul class="pagination justify-content-center">
                                                    <!-- Pagination buttons will be inserted here -->
                                                </ul>
                                            </nav>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div style="clear: both;"></div>
        <div class="footer">
            <div class="container">
                <div class="col-sm-12">
                    <div class="col-sm-3" style="float: left;">
                        <img src="../assets/logo_all.png" alt="logo" class="navbar-brand">
                    </div>
                    <div class="col-sm-9" style="float: left; text-align: right; padding-top: 15px; font-weight: 700; color: #003A5D;">
                        Copyright © 2025 by <a href="http://allinyourmind.es/" target="_blank">ALL IN YOUR MIND</a>
                    </div>
                </div>
            </div>
            <div style="clear: both;"></div>
        </div>
    </div>

    <script src="../assets/jquery.min.js.descarga"></script>
    <script src="../assets/bootstrap.min.js.descarga"></script>
    <script src="../assets/atlantis2.min.js.descarga"></script>
    
    <script>
        let allMesos = [];
        let filteredMesos = [];
        let currentPage = 1;
        let totalPages = 1;
        const limit = 50;

        $(document).ready(function() {
            loadMesociclos(1);
            
            $('#filterInput').on('input', function() {
                filterMesos($(this).val());
            });
            
            $('#clearFilter').on('click', function() {
                $('#filterInput').val('');
                filterMesos('');
            });
        });

        async function loadMesociclos(page = 1) {
            try {
                currentPage = page;
                const response = await fetch(`/api/mesociclos?page=${page}&limit=${limit}`);
                const data = await response.json();
                
                $('#loadingMesos').hide();
                
                if (data.success && data.mesociclos.length > 0) {
                    allMesos = data.mesociclos;
                    filteredMesos = allMesos;
                    totalPages = data.pagination.totalPages;
                    displayMesos(allMesos);
                    updateResultCount(data.pagination.total);
                    updatePagination(data.pagination);
                    $('#w0').show();
                } else {
                    $('#w0').html('<div class="text-center py-4 text-muted"><p>No hay mesociclos disponibles</p></div>').show();
                }
            } catch (error) {
                console.error('Error:', error);
                $('#loadingMesos').hide();
                $('#w0').html('<div class="text-center py-4 text-danger"><p>Error al cargar mesociclos</p></div>').show();
            }
        }

        function displayMesos(mesos) {
            const tbody = $('#mesosTableBody');
            tbody.empty();
            
            mesos.forEach((meso, index) => {
                const globalIndex = (currentPage - 1) * limit + index + 1;
                const row = `
                    <tr data-key="${index}">
                        <td data-th="#">${globalIndex}</td>
                        <td data-th="Código : " style="vertical-align: top;">${meso.nombre}</td>
                        <td>
                            <a href="detalle-mesociclo.html?id=${meso.id}" title="Ver detalle" data-pjax="0">
                                <i style="width:23px; font-size:17px; color:#003a5d; font-weight:500" class="fas fa-eye"></i>
                            </a>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function updatePagination(pagination) {
            if (pagination.totalPages <= 1) {
                $('#pagination').hide();
                return;
            }

            const paginationDiv = $('#pagination');
            const paginationUl = paginationDiv.find('ul.pagination');
            
            paginationUl.empty();

            let paginationHTML = '';

            // Previous button
            const prevDisabled = pagination.page === 1 ? 'disabled' : '';
            paginationHTML += `
                <li class="page-item ${prevDisabled}">
                    <a class="page-link" href="#" onclick="loadMesociclos(${pagination.page - 1}); return false;" ${prevDisabled ? 'tabindex="-1"' : ''}>Anterior</a>
                </li>
            `;

            // Page numbers - Show more pages
            const startPage = Math.max(1, pagination.page - 3);
            const endPage = Math.min(pagination.totalPages, pagination.page + 3);

            if (startPage > 1) {
                paginationHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="loadMesociclos(1); return false;">1</a>
                    </li>
                `;
                if (startPage > 2) {
                    paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const active = i === pagination.page ? 'active' : '';
                paginationHTML += `
                    <li class="page-item ${active}">
                        <a class="page-link" href="#" onclick="loadMesociclos(${i}); return false;">${i}</a>
                    </li>
                `;
            }

            if (endPage < pagination.totalPages) {
                if (endPage < pagination.totalPages - 1) {
                    paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
                paginationHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="loadMesociclos(${pagination.totalPages}); return false;">${pagination.totalPages}</a>
                    </li>
                `;
            }

            // Next button
            const nextDisabled = pagination.page === pagination.totalPages ? 'disabled' : '';
            paginationHTML += `
                <li class="page-item ${nextDisabled}">
                    <a class="page-link" href="#" onclick="loadMesociclos(${pagination.page + 1}); return false;" ${nextDisabled ? 'tabindex="-1"' : ''}>Siguiente</a>
                </li>
            `;

            paginationUl.html(paginationHTML);
            paginationDiv.show();
        }

        function filterMesos(searchTerm) {
            if (!searchTerm) {
                filteredMesos = allMesos;
            } else {
                filteredMesos = allMesos.filter(meso => 
                    meso.nombre.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            displayMesos(filteredMesos);
            updateResultCount();
        }

        function updateResultCount(total = null) {
            const count = filteredMesos.length;
            const displayTotal = total || count;
            $('#resultCount').text(`Viendo ${count} de ${displayTotal} resultados.`);
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        }
    </script>
</body>
</html>
