<!DOCTYPE html>
<html lang="ES-es">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Aiym Panel :: AIYM YUC</title>
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <link rel="icon" type="image/png" href="../assets/favicon-32x32.png">
    
    <link href="../assets/fonts.min.css" rel="stylesheet">
    <link href="../assets/bootstrap.min.css" rel="stylesheet">
    <link href="../assets/atlantis2.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/demo.css">
    <link rel="stylesheet" href="../assets/alertif.min.css">
    <link rel="stylesheet" href="../assets/training-app-styles.css">
    <link rel="stylesheet" href="../assets/modern-font.css">
</head>

<body data-background-color="bg3">
    <div class="wrapper page-container">
        <div class="main-header" data-background-color="white">
            <div class="nav-top">
                <div class="container d-flex flex-row">
                    <button class="topbar-toggler more"><i class="icon-options-vertical"></i></button>
                    <a class="logo d-flex align-items-center" href="../index.html">
                        <img src="../assets/logo_all.png" alt="logo" class="navbar-brand">
                    </a>
                    
                    <nav class="navbar navbar-header navbar-expand-lg p-0">
                        <div class="container-fluid p-0">
                            <ul class="navbar-nav topbar-nav ml-md-auto align-items-center">
                                <li class="nav-item dropdown hidden-caret">
                                    <a class="dropdown-toggle profile-pic" data-toggle="dropdown" href="#" aria-expanded="false">
                                        <div style="float: left; padding: 10px 7px; color: #535353;">| YUC</div>
                                        <div class="avatar-sm" style="float: left;">
                                            <img src="../assets/user_242.png" alt="..." class="avatar-img rounded-circle imgshadow">
                                        </div>
                                    </a>
                                    <ul class="dropdown-menu dropdown-user animated fadeIn">
                                        <div class="dropdown-user-scroll scrollbar-outer">
                                            <li>
                                                <div class="user-box">
                                                    <div class="avatar-lg">
                                                        <img src="../assets/user_242.png" alt="image profile" class="avatar-img rounded">
                                                    </div>
                                                    <div class="u-text">
                                                        <h4></h4>
                                                        <p class="text-muted">AIYM YUC</p>
                                                    </div>
                                                </div>
                                            </li>
                                            <li>
                                                <div class="dropdown-divider"></div>
                                                <a class="dropdown-item" href="#" onclick="logout(); return false;" style="color:#777; font-weight:400;">Salir</a>
                                            </li>
                                        </div>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </nav>
                </div>
            </div>
        </div>

        <div class="main-panel">
            <div class="container" style="min-height: 550px;">
                <div class="page-inner">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="page-header">
                                <h4 class="page-title">Listado de Microciclos</h4>
                                <ul class="breadcrumbs" style="font-weight: 400;">
                                    <li class="nav-home">
                                        <a href="../index.html"><i class="flaticon-home"></i></a>
                                    </li>
                                    <li class="separator"><i class="flaticon-right-arrow"></i></li>
                                    <li class="nav-item">Consulta</li>
                                </ul>
                            </div>
                            
                            <div class="card">
                                <div class="card-body">
                                    <div id="loadingMicros" class="text-center py-5">
                                        <div class="spinner-border" style="width: 3rem; height: 3rem; color: #003B5C;" role="status">
                                            <span class="sr-only">Cargando...</span>
                                        </div>
                                        <p class="mt-3 text-muted">Cargando microciclos...</p>
                                    </div>
                                    <div id="w0" class="grid-view" style="display:none;">
                                        <a href="javascript:;" id="clearFilter" style="color:#003e59;"><i class="fa fa-minus-square"></i> Limpiar filtro</a> | <span id="resultCount">Viendo 0 de 0 resultados.</span>
                                        <table class="table table-striped table-bordered tblresponsive">
                                            <colgroup>
                                                <col>
                                                <col>
                                                <col style="width:110px;">
                                            </colgroup>
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th>Código</th>
                                                    <th class="action-column">&nbsp;</th>
                                                </tr>
                                                <tr id="w0-filters" class="filters">
                                                    <td data-th="Buscar por:">&nbsp;</td>
                                                    <td data-th="Código">
                                                        <input type="text" class="form-control" id="filterInput" placeholder="Buscar...">
                                                    </td>
                                                    <td>&nbsp;</td>
                                                </tr>
                                            </thead>
                                            <tbody id="microsTableBody">
                                                <!-- Rows will be loaded here -->
                                            </tbody>
                                        </table>
                                        
                                        <div id="pagination" class="text-center mt-3" style="display:none;">
                                            <nav>
                                                <ul class="pagination justify-content-center">
                                                    <!-- Pagination buttons will be inserted here -->
                                                </ul>
                                            </nav>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div style="clear: both;"></div>
        <div class="footer">
            <div class="container">
                <div class="col-sm-12">
                    <div class="col-sm-3" style="float: left;">
                        <img src="../assets/logo_all.png" alt="logo" class="navbar-brand">
                    </div>
                    <div class="col-sm-9" style="float: left; text-align: right; padding-top: 15px; font-weight: 700; color: #003A5D;">
                        Copyright © 2025 by <a href="http://allinyourmind.es/" target="_blank">ALL IN YOUR MIND</a>
                    </div>
                </div>
            </div>
            <div style="clear: both;"></div>
        </div>
    </div>

    <script src="../assets/jquery.min.js.descarga"></script>
    <script src="../assets/bootstrap.min.js.descarga"></script>
    <script src="../assets/atlantis2.min.js.descarga"></script>
    <script src="../assets/api-adapter.js"></script>
    
    <script>
        let allMicros = [];
        let filteredMicros = [];
        let currentPage = 1;
        let totalPages = 1;
        const limit = 100; // 100 microciclos por página

        $(document).ready(function() {
            loadMicrociclos(1);
            
            $('#filterInput').on('input', function() {
                filterMicros($(this).val());
            });
            
            $('#clearFilter').on('click', function() {
                $('#filterInput').val('');
                filterMicros('');
            });
        });

        async function loadMicrociclos(page = 1) {
            try {
                currentPage = page;
                const response = await fetch(`/api/microciclos?page=${page}&limit=${limit}`);
                const data = await response.json();
                
                if (data.success) {
                    allMicros = data.microciclos || [];
                    filteredMicros = [...allMicros];
                    totalPages = data.totalPages || 1;
                    
                    renderTable();
                    renderPagination();
                    
                    $('#loadingMicros').hide();
                    $('#w0').show();
                    updateResultCount();
                } else {
                    showError(data.error || 'Error al cargar microciclos');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Error al cargar microciclos');
            }
        }

        function renderTable() {
            const tbody = $('#microsTableBody');
            tbody.empty();
            
            if (filteredMicros.length === 0) {
                tbody.html('<tr><td colspan="3" class="text-center py-4">No se encontraron microciclos</td></tr>');
                return;
            }
            
            filteredMicros.forEach((micro, index) => {
                const rowNum = (currentPage - 1) * limit + index + 1;
                const row = `
                    <tr>
                        <td data-th="#">${rowNum}</td>
                        <td data-th="Código">${micro.nombre || micro.codigo || 'Sin código'}</td>
                        <td class="action-column">
                            <a href="detalle-microciclo.html?id=${micro.id}" title="Ver" aria-label="Ver">
                                <i class="far fa-eye"></i>
                            </a>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function renderPagination() {
            const pagination = $('#pagination ul');
            pagination.empty();
            
            if (totalPages <= 1) {
                $('#pagination').hide();
                return;
            }
            
            $('#pagination').show();
            
            // Botón anterior
            const prevDisabled = currentPage === 1 ? 'disabled' : '';
            pagination.append(`
                <li class="page-item ${prevDisabled}">
                    <a class="page-link" href="javascript:void(0)" onclick="changePage(${currentPage - 1})">
                        <span aria-hidden="true">«</span>
                    </a>
                </li>
            `);
            
            // Páginas
            const maxButtons = 10;
            let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxButtons - 1);
            
            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const active = i === currentPage ? 'active' : '';
                pagination.append(`
                    <li class="page-item ${active}">
                        <a class="page-link" href="javascript:void(0)" onclick="changePage(${i})">${i}</a>
                    </li>
                `);
            }
            
            // Botón siguiente
            const nextDisabled = currentPage === totalPages ? 'disabled' : '';
            pagination.append(`
                <li class="page-item ${nextDisabled}">
                    <a class="page-link" href="javascript:void(0)" onclick="changePage(${currentPage + 1})">
                        <span aria-hidden="true">»</span>
                    </a>
                </li>
            `);
        }

        function changePage(page) {
            if (page < 1 || page > totalPages) return;
            loadMicrociclos(page);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function filterMicros(searchTerm) {
            if (!searchTerm) {
                filteredMicros = [...allMicros];
            } else {
                const term = searchTerm.toLowerCase();
                filteredMicros = allMicros.filter(micro => {
                    const codigo = (micro.nombre || micro.codigo || '').toLowerCase();
                    return codigo.includes(term);
                });
            }
            renderTable();
            updateResultCount();
        }

        function updateResultCount() {
            const total = filteredMicros.length;
            const showing = Math.min(limit, total);
            $('#resultCount').text(`Viendo ${showing} de ${total} resultados.`);
        }

        function showError(message) {
            $('#loadingMicros').html(`
                <div class="alert alert-danger text-center">
                    <i class="fas fa-exclamation-triangle"></i> ${message}
                </div>
            `);
        }

        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = '../login.html';
        }
    </script>
</body>
</html>
