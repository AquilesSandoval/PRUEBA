<!DOCTYPE html>
<html lang="ES-es">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Aiym Panel :: AIYM YUC</title>
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <link rel="icon" type="image/png" href="../assets/favicon-32x32.png">
    
    <link href="../assets/fonts.min.css" rel="stylesheet">
    <link href="../assets/bootstrap.min.css" rel="stylesheet">
    <link href="../assets/atlantis2.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/demo.css">
    <link rel="stylesheet" href="../assets/alertif.min.css">
    <link rel="stylesheet" href="../assets/training-app-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>

<body data-background-color="bg3">
    <div class="wrapper page-container">
        <div class="main-header" data-background-color="white">
            <div class="nav-top">
                <div class="container d-flex flex-row">
                    <button class="topbar-toggler more"><i class="icon-options-vertical"></i></button>
                    <a class="logo d-flex align-items-center" href="../index.html">
                        <img src="../assets/logo_all.png" alt="logo" class="navbar-brand">
                    </a>
                    
                    <nav class="navbar navbar-header navbar-expand-lg p-0">
                        <div class="container-fluid p-0">
                            <ul class="navbar-nav topbar-nav ml-md-auto align-items-center">
                                <li class="nav-item dropdown hidden-caret">
                                    <a class="dropdown-toggle profile-pic" data-toggle="dropdown" href="#" aria-expanded="false">
                                        <div style="float: left; padding: 10px 7px; color: #535353;">| YUC</div>
                                        <div class="avatar-sm" style="float: left;">
                                            <img src="../assets/user_242.png" alt="..." class="avatar-img rounded-circle imgshadow">
                                        </div>
                                    </a>
                                    <ul class="dropdown-menu dropdown-user animated fadeIn">
                                        <div class="dropdown-user-scroll scrollbar-outer">
                                            <li>
                                                <div class="user-box">
                                                    <div class="avatar-lg">
                                                        <img src="../assets/user_242.png" alt="image profile" class="avatar-img rounded">
                                                    </div>
                                                    <div class="u-text">
                                                        <h4></h4>
                                                        <p class="text-muted">AIYM YUC</p>
                                                    </div>
                                                </div>
                                            </li>
                                            <li>
                                                <div class="dropdown-divider"></div>
                                                <a class="dropdown-item" href="#" onclick="logout(); return false;" style="color:#777; font-weight:400;">Salir</a>
                                            </li>
                                        </div>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </nav>
                </div>
            </div>
        </div>

        <div class="main-panel">
            <div class="container" style="min-height: 550px;">
                <div class="page-inner">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="page-header">
                                <h4 class="page-title">Listado de Macrociclos</h4>
                                <ul class="breadcrumbs" style="font-weight: 400;">
                                    <li class="nav-home">
                                        <a href="../index.html"><i class="flaticon-home"></i></a>
                                    </li>
                                    <li class="separator"><i class="flaticon-right-arrow"></i></li>
                                    <li class="nav-item">Consulta</li>
                                </ul>
                            </div>
                            
                            <div class="card">
                                <div class="card-body">
                                    <div id="loadingMacros" class="text-center py-5">
                                        <i class="fas fa-spinner fa-spin fa-3x" style="color: #003B5C;"></i>
                                        <p class="mt-3 text-muted">Cargando macrociclos...</p>
                                    </div>
                                    <div id="w0" class="grid-view" style="display:none;">
                                        <a href="javascript:;" id="clearFilter" style="color:#003e59;"><i class="fa fa-minus-square"></i> Limpiar filtro</a> | <span id="resultCount">Viendo 0 de 0 resultados.</span>
                                        <table class="table table-striped table-bordered tblresponsive">
                                            <colgroup>
                                                <col>
                                                <col>
                                                <col style="width:110px;">
                                            </colgroup>
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th>Código</th>
                                                    <th class="action-column">&nbsp;</th>
                                                </tr>
                                                <tr id="w0-filters" class="filters">
                                                    <td data-th="Buscar por:">&nbsp;</td>
                                                    <td data-th="Código">
                                                        <input type="text" class="form-control" id="filterInput" placeholder="Buscar...">
                                                    </td>
                                                    <td>&nbsp;</td>
                                                </tr>
                                            </thead>
                                            <tbody id="macrosTableBody">
                                                <!-- Rows will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div style="clear: both;"></div>
        <div class="footer">
            <div class="container">
                <div class="col-sm-12">
                    <div class="col-sm-3" style="float: left;">
                        <img src="../assets/logo_all.png" alt="logo" class="navbar-brand">
                    </div>
                    <div class="col-sm-9" style="float: left; text-align: right; padding-top: 15px; font-weight: 700; color: #003A5D;">
                        Copyright © 2025 by <a href="http://allinyourmind.es/" target="_blank">ALL IN YOUR MIND</a>
                    </div>
                </div>
            </div>
            <div style="clear: both;"></div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/atlantis2.min.js"></script>
    
    <script>
        let allMacros = [];
        let filteredMacros = [];

        $(document).ready(function() {
            loadMacrociclos();
            
            $('#filterInput').on('input', function() {
                filterMacros($(this).val());
            });
            
            $('#clearFilter').on('click', function() {
                $('#filterInput').val('');
                filterMacros('');
            });
        });

        async function loadMacrociclos() {
            try {
                const response = await fetch('/api/macrociclos');
                const data = await response.json();
                
                $('#loadingMacros').hide();
                
                if (data.success && data.macrociclos.length > 0) {
                    allMacros = data.macrociclos;
                    filteredMacros = allMacros;
                    displayMacros(allMacros);
                    updateResultCount();
                    $('#w0').show();
                } else {
                    $('#w0').html('<div class="text-center py-4 text-muted"><p>No hay macrociclos disponibles</p></div>').show();
                }
            } catch (error) {
                console.error('Error:', error);
                $('#loadingMacros').hide();
                $('#w0').html('<div class="text-center py-4 text-danger"><p>Error al cargar macrociclos</p></div>').show();
            }
        }

        function displayMacros(macros) {
            const tbody = $('#macrosTableBody');
            tbody.empty();
            
            macros.forEach((macro, index) => {
                const row = `
                    <tr data-key="${index}">
                        <td data-th="#">${index + 1}</td>
                        <td data-th="Código : " style="vertical-align: top;">${macro.nombre}</td>
                        <td>
                            <a href="detalle-macrociclo.html?id=${macro.id}" title="Ver detalle" data-pjax="0">
                                <i style="width:23px; font-size:17px; color:#003a5d; font-weight:500" class="fas fa-eye"></i>
                            </a>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function filterMacros(searchTerm) {
            if (!searchTerm) {
                filteredMacros = allMacros;
            } else {
                filteredMacros = allMacros.filter(macro => 
                    macro.nombre.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            displayMacros(filteredMacros);
            updateResultCount();
        }

        function updateResultCount() {
            const count = filteredMacros.length;
            const total = allMacros.length;
            $('#resultCount').text(`Viendo ${count} de ${total} resultados.`);
        }

        function copiarMacro(id, nombre) {
            alert('Función copiar macrociclo: ' + nombre);
        }

        function moverMacro(id, nombre) {
            alert('Función mover macrociclo: ' + nombre);
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        }
    </script>
</body>
</html>
